<script>
  const refreshBtn = document.getElementById("refreshBtn");
  let isLoading = false;
  let lastPrice = 0;  // Last successful price save karne ke liye

  async function loadGoldPrice() {
    const errorEl = document.getElementById("error");
    errorEl.innerText = "";

    if (isLoading) return;
    isLoading = true;
    refreshBtn.disabled = true;
    refreshBtn.innerText = "Refreshing...";

    try {
      const res = await fetch("https://api.coingecko.com/api/v3/simple/price?ids=gold&vs_currencies=usd");

      if (!res.ok) throw new Error("API unavailable");

      const data = await res.json();
      const ounceUSD = data.gold?.usd;

      if (!ounceUSD || isNaN(ounceUSD)) throw new Error("No valid price");

      lastPrice = ounceUSD; // Save kar le

      document.getElementById("ounceUSD").innerText = `Gold per Ounce (USD): ${ounceUSD.toFixed(2)}`;

      const gold24gm = (ounceUSD * 1.4485 + 15) / 116.64;
      const gold22gm = gold24gm * 0.921;
      const gold21gm = gold24gm * 0.880;
      const gold18gm = gold24gm * 0.755;
      const tola21 = gold21gm * 11.664;

      document.getElementById("g24").innerText = gold24gm.toFixed(3);
      document.getElementById("g22").innerText = gold22gm.toFixed(3);
      document.getElementById("g21gm").innerText = gold21gm.toFixed(3);
      document.getElementById("g18").innerText = gold18gm.toFixed(3);
      document.getElementById("tola21").innerText = tola21.toFixed(2);

      const now = new Date();
      const muscatTime = now.toLocaleString("en-US", {
        timeZone: "Asia/Muscat",
        dateStyle: "medium",
        timeStyle: "short"
      });
      document.getElementById("time").innerText = `Last updated: ${muscatTime} (Muscat Time)`;

    } catch (err) {
      console.error(err);
      errorEl.innerText = "Live price nahi mil raha. Last known price use kar raha hoon.";

      // Fallback to last known price
      if (lastPrice > 0) {
        document.getElementById("ounceUSD").innerText = `Gold per Ounce (USD): ${lastPrice.toFixed(2)} (last known)`;

        const gold24gm = (lastPrice * 1.4485 + 15) / 116.64;
        const gold22gm = gold24gm * 0.921;
        const gold21gm = gold24gm * 0.880;
        const gold18gm = gold24gm * 0.755;
        const tola21 = gold21gm * 11.664;

        document.getElementById("g24").innerText = gold24gm.toFixed(3);
        document.getElementById("g22").innerText = gold22gm.toFixed(3);
        document.getElementById("g21gm").innerText = gold21gm.toFixed(3);
        document.getElementById("g18").innerText = gold18gm.toFixed(3);
        document.getElementById("tola21").innerText = tola21.toFixed(2);
      } else {
        document.getElementById("ounceUSD").innerText = "Gold per Ounce (USD): Error - Try again";
      }
    } finally {
      isLoading = false;
      refreshBtn.disabled = false;
      refreshBtn.innerText = "Refresh Rates";
    }
  }

  window.addEventListener('load', loadGoldPrice);
  refreshBtn.addEventListener('click', loadGoldPrice);

  // Auto refresh har 5 min
  setInterval(loadGoldPrice, 5 * 60 * 1000);
</script>

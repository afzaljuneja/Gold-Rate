<script>
  const CACHE_KEY = "gold_price_cache_metals";
  const CACHE_TIME = 10 * 60 * 1000; // 10 minutes

  const refreshBtn = document.getElementById("refreshBtn");
  let isLoading = false;

  async function loadGoldPrice(force = false) {
    const errorEl = document.getElementById("error");
    errorEl.innerText = "";

    if (isLoading) return;
    isLoading = true;
    refreshBtn.disabled = true;
    refreshBtn.innerText = "Refreshing...";

    try {
      // Cache check
      const cached = localStorage.getItem(CACHE_KEY);
      if (cached && !force) {
        const parsed = JSON.parse(cached);
        if (Date.now() - parsed.time < CACHE_TIME) {
          applyPrice(parsed.price, "(cached)");
          return;
        }
      }

      // Keyless API - metals.live (no key needed)
      const res = await fetch("https://api.metals.live/v1/spot");
      if (!res.ok) throw new Error("API unavailable");

      const data = await res.json();
      const ounceUSD = data[0]?.gold || 0;  // gold price yahan milta hai

      if (!ounceUSD || isNaN(ounceUSD)) throw new Error("No valid price");

      // Save cache
      localStorage.setItem(CACHE_KEY, JSON.stringify({ price: ounceUSD, time: Date.now() }));

      applyPrice(ounceUSD, "");

    } catch (err) {
      console.error(err);
      errorEl.innerText = "API busy hai ya limit khatam. Thodi der baad refresh try karo.";

      // Fallback to cache
      const cached = localStorage.getItem(CACHE_KEY);
      if (cached) {
        const parsed = JSON.parse(cached);
        applyPrice(parsed.price, "(old cached data)");
      } else {
        document.getElementById("ounceUSD").innerText = "Gold per Ounce (USD): Error - Try refresh";
      }
    } finally {
      isLoading = false;
      refreshBtn.disabled = false;
      refreshBtn.innerText = "Refresh Rates";
    }
  }

  function applyPrice(ounceUSD, note) {
    document.getElementById("ounceUSD").innerText = `Gold per Ounce (USD): ${ounceUSD.toFixed(2)} ${note}`;

    const gold24gm = (ounceUSD * 1.4485 + 15) / 116.64;
    const gold22gm = gold24gm * 0.921;
    const gold21gm = gold24gm * 0.880;
    const gold18gm = gold24gm * 0.755;
    const tola21 = gold21gm * 11.664;

    document.getElementById("g24").innerText = gold24gm.toFixed(3);
    document.getElementById("g22").innerText = gold22gm.toFixed(3);
    document.getElementById("g21gm").innerText = gold21gm.toFixed(3);
    document.getElementById("g18").innerText = gold18gm.toFixed(3);
    document.getElementById("tola21").innerText = tola21.toFixed(2);

    const now = new Date();
    const muscatTime = now.toLocaleString("en-US", {
      timeZone: "Asia/Muscat",
      dateStyle: "medium",
      timeStyle: "short"
    });
    document.getElementById("time").innerText = `Last updated: ${muscatTime} (Muscat Time)`;
  }

  window.addEventListener("load", () => loadGoldPrice());
  refreshBtn.addEventListener("click", () => loadGoldPrice(true));
</script>
